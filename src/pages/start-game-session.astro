---
export const prerender = false;
let error = "";
let success = "";
let courts = "";

// Simple GUID generator
function uuidv4() {
  return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function (c) {
    var r = (Math.random() * 16) | 0,
      v = c == "x" ? r : (r & 0x3) | 0x8;
    return v.toString(16);
  });
}

if (Astro.request.method === "POST") {
  const REDIS_URL = 'redis://default:BhTmCNTYNczSkuH3PGwYcF0T11Ng4cah@redis-17112.c338.eu-west-2-1.ec2.cloud.redislabs.com:17112';

  let sessionExists = false;
  try {
    const apiUrl = new URL('/api/data.json', Astro.url.origin).href;
    const res = await fetch(apiUrl);
    if (res.ok) {
      const data = await res.json();
      const badmintonSession = data.badmintonSession ?? null;
      if (badmintonSession && Array.isArray(badmintonSession.courts) && badmintonSession.courts.length > 0) {
        sessionExists = true;
      }
    } else {
      console.warn('/api/data.json returned non-OK status when checking session:', res.status);
    }
  } catch (e) {
    console.error('Error checking session via API:', e);
  }

  if (sessionExists) {
    return new Response(null, {
      status: 303,
      headers: {
        Location: "/?error=Game%20is%20in%20play.%20Use%20End%20Game%20Session%20to%20cancel%20the%20Games",
      },
    });
  }

  const formData = await Astro.request.formData();
  const courtsValue = formData.get("courts");
  courts = typeof courtsValue === "string" ? courtsValue : "";
  const numCourts = Number(courts);
  if (!numCourts || numCourts < 1 || numCourts > 4) {
    error = "Number of courts must be between 1 and 4.";
  } else {
    const session = {
      courts: Array.from({ length: numCourts }, (_, i) => ({
        courtNumber: i + 1,
        sessionId: uuidv4(),
      })),
    };

    // Write to Redis
    try {
      const { createClient } = await import('redis');
      const client = createClient({ url: REDIS_URL });
      client.on('error', (err) => console.error('Redis error', err));
      await client.connect();
      await client.set('badmintonSession.json', JSON.stringify(session, null, 2));
      await client.disconnect();
      success = `Session started with ${numCourts} court(s).`;
      courts = "";
      return new Response(null, { status: 303, headers: { Location: '/' } });
    } catch (e) {
      console.error('Error writing session to redis:', e);
      error = 'Failed to start session. Please try again.';
    }
  }
}
---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Start Game Session</title>
  </head>
  <body class="bg-teal-300 min-h-screen font-sans">
    <main class="max-w-md mx-auto mt-10 bg-white rounded shadow p-6">
      <h2 class="text-xl font-bold mb-4">Start Game Session</h2>
      <form method="POST">
        <label class="block mb-2 font-semibold">No of Courts</label>
        <input
          name="courts"
          type="number"
          min="1"
          max="4"
          required
          class="border rounded px-3 py-2 w-full mb-4"
          value={courts}
        />
        {error && <div class="text-red-500 mb-2">{error}</div>}
        {success && <div class="text-green-600 mb-2">{success}</div>}
        <button
          type="submit"
          class="px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700 transition"
          >Start Session</button
        >
      </form>
    </main>
  </body>
</html>

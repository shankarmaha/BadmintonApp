---
import { readFile } from 'fs/promises';
import { head } from '@vercel/blob';
export const prerender = false;
import PlayerList from '../components/PlayerList';
import BadmintonSession from '../components/BadmintonSession';

import { getPlayers, getPlayersQueue } from '../data/playerStore.js';



// Vercel Blob settings
const VERCEL_BLOB_BASE_URL = 'https://5lmahcr7eatdowvx.public.blob.vercel-storage.com';
const VERCEL_BLOB_OBJECT_URL = `${VERCEL_BLOB_BASE_URL.replace(/\/$/, '')}/playerGames.json`;
const BLOB_TOKEN = import.meta.env.BLOB_READ_WRITE_TOKEN;

// Simple in-memory cache for the blob data
let _playerGamesCache: any[] | null = null;
let _playerGamesCacheExpires = 0;

// Fetch helper: try blob first, then fallback to local data/playerGames.json
async function fetchPlayerGamesCached(ttlMs = 3000) {
  const now = Date.now();
  if (_playerGamesCache && _playerGamesCacheExpires > now) return _playerGamesCache;

  // Try Vercel Blob only if token is set
  if (VERCEL_BLOB_OBJECT_URL && BLOB_TOKEN) {
    try {
      console.log('Fetching playerGames from Vercel Blob...');
      // Create an abort controller with a 5-second timeout
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 5000);
      
      const meta = await head(VERCEL_BLOB_OBJECT_URL, { 
        token: BLOB_TOKEN,
        abortSignal: controller.signal
      });
      clearTimeout(timeoutId);
      console.log('Vercel Blob metadata:', meta);
      const downloadUrl = meta.downloadUrl ?? meta.url ?? VERCEL_BLOB_OBJECT_URL;
      // In dev, disable strict SSL verification to allow blob fetch
      if (process.env.NODE_ENV === 'development' || import.meta.env.DEV) {
        process.env.NODE_TLS_REJECT_UNAUTHORIZED = '0';
      }
      const res = await fetch(downloadUrl);
      if (res.ok) {
        const text = await res.text();
        const data = text ? JSON.parse(text) : [];
        _playerGamesCache = data;
        _playerGamesCacheExpires = now + ttlMs;
        return data;
      } else {
        console.warn('Vercel Blob returned', res.status);
      }
    } catch (e) {
      console.warn('Vercel Blob fetch failed, falling back to local file:', e);
    }
  } else {
    if (!BLOB_TOKEN) {
      console.warn('BLOB_READ_WRITE_TOKEN not set, skipping Vercel Blob fetch');
    }
  }

  // Fallback to local file
  try {
    const txt = await readFile(new URL('../data/playerGames.json', import.meta.url), 'utf-8');
    const data = txt ? JSON.parse(txt) : [];
    _playerGamesCache = data;
    _playerGamesCacheExpires = now + ttlMs;
    return data;
  } catch (e) {
    console.error('Failed to read local playerGames.json fallback:', e);
    return [];
  }
}

// Fetch all data (playerGames stored in blob or local file)
let playerGames: any[] = [];
let playersQueue: any[] = [];
let allPlayers: any[] = [];

try {
  [playersQueue, allPlayers] = await Promise.all([
    getPlayersQueue(),
    getPlayers()
  ]);

  playerGames = await fetchPlayerGamesCached();
} catch (err) {
  console.error('Error fetching data:', err);
  playersQueue = [];
  allPlayers = [];
  playerGames = [];
}

// Build the list to display: for each guid in playersQueue, get name, arrivedDateTime from players, and noOfGamesPlayed from playerGames
const players = playersQueue.map(q => {
  const player = allPlayers.find(p => p.guid === q.guid) || {};
  const games = playerGames.find(g => g.guid === q.guid) || { noOfGamesPlayed: 0 };
  return {
    guid: q.guid,
    name: player.name || '',
    arrivedDateTime: player.arrivedDateTime ? player.arrivedDateTime.split(':').slice(0,2).join(':') : '',
    noOfGamesPlayed: games.noOfGamesPlayed
  };
});

---
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Home | Player List</title>
  </head>
  <body class="bg-teal-300 min-h-screen font-sans">
    <nav class="bg-white shadow p-4 flex justify-between items-center">
      <h1 class="text-2xl font-bold text-orange-500">CPS Game Picker</h1>
      <div class="flex items-center gap-4">
        <a href="/add-player" class="px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 transition">Add Player</a>
        <a href="/player-stats" class="ml-4 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">Player Stats</a>
        <a href="/game-stats" class="ml-4 px-4 py-2 bg-pink-600 text-white rounded hover:bg-pink-700 transition">Game Stats</a>
        <button id="pick-game-btn" class="px-4 py-2 bg-teal-500 text-white rounded hover:bg-teal-600 transition">Pick Game</button>
        <div class="relative group">
          <button class="px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700 transition focus:outline-none">Game Setup</button>
          <div class="absolute right-0 mt-2 w-48 bg-white rounded shadow-lg opacity-0 group-hover:opacity-100 group-focus-within:opacity-100 transition-opacity z-10">
            <a href="/start-game-session" class="block px-4 py-2 text-gray-700 hover:bg-teal-100">Start Game Session</a>
            <a href="#" id="end-session-link" class="block px-4 py-2 text-gray-700 hover:bg-teal-100">End Game Session</a>
          </div>
        </div>
      </div>
    </nav>
    <main class="max-w-7xl mx-auto mt-10 flex flex-col md:flex-row gap-8">
      <section class="md:w-1/3 w-full bg-white rounded shadow p-6 mb-8 md:mb-0">
        <PlayerList client:load players={players}/>
      </section>
      <section class="md:w-2/3 w-full bg-white rounded shadow p-6">
        <BadmintonSession client:load />
      </section>
    </main>
    <script>
      // Show a styled modal popup if error query param is present
      window.addEventListener('DOMContentLoaded', () => {
        const params = new URLSearchParams(window.location.search);
        const error = params.get('error');
        if (error) {
          const modal = document.createElement('div');
          modal.id = 'error-modal';
          modal.innerHTML = `
            <div class="fixed inset-0 flex items-center justify-center z-50">
              <div class="absolute inset-0 bg-black opacity-40"></div>
              <div class="relative bg-white rounded-lg shadow-lg p-6 max-w-sm w-full text-center">
                <div class="text-red-600 text-lg font-semibold mb-2">Error</div>
                <div class="mb-4">${decodeURIComponent(error)}</div>
                <button id="close-error-modal" class="px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700 transition">Close</button>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
          document.getElementById('close-error-modal').onclick = () => {
            modal.remove();
            // Remove error param from URL
            const url = new URL(window.location.href);
            url.searchParams.delete('error');
            window.history.replaceState({}, document.title, url.pathname + url.search);
          };
        }
        // Pick Game button logic
        const pickGameBtn = document.getElementById('pick-game-btn');
        if (pickGameBtn) {
          pickGameBtn.onclick = async () => {
            try {
              const res = await fetch('/api/pick-game', { method: 'POST' });
              location.reload(); // Reload the page to refresh BadmintonSession
            } catch (err) {
              alert('Error picking game');
            }
          };
        }
        // End Game Session link logic
        const endSessionLink = document.getElementById('end-session-link');
        if (endSessionLink) {
          endSessionLink.onclick = (e) => {
            e.preventDefault();
            const modal = document.createElement('div');
            modal.id = 'end-session-modal';
            modal.innerHTML = `
              <div class="fixed inset-0 flex items-center justify-center z-50">
                <div class="absolute inset-0 bg-black opacity-40"></div>
                <div class="relative bg-white rounded-lg shadow-lg p-6 max-w-sm w-full text-center border-2 border-red-600">
                  <div class="text-red-600 text-3xl mb-2">&#9888;</div>
                  <div class="text-lg font-semibold mb-4">Game session in progress. Do you want to end the session?</div>
                  <div class="flex justify-center gap-4">
                    <button id="confirm-end-session" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Yes</button>
                    <button id="cancel-end-session" class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">No</button>
                  </div>
                </div>
              </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('cancel-end-session').onclick = () => {
              modal.remove();
            };
            document.getElementById('confirm-end-session').onclick = async () => {
              await fetch('/api/end-session', { method: 'POST' });
              modal.remove();
              location.reload();
            };
          };
        }
      });
    </script>
  </body>
</html>
